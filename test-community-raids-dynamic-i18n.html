<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Raids Dynamic i18n Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #1a1a1a; 
            color: white; 
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #333; 
            border-radius: 8px; 
        }
        .test-button { 
            background: #FF6B35; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            margin: 8px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px;
        }
        .test-button:hover { background: #e55a2b; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            background: #2a2a2a; 
            border-radius: 4px; 
        }
        .current-lang {
            background: #FF6B35;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
        }
        .demo-raid-item {
            padding: 15px;
            margin: 10px 0;
            background: #333;
            border-radius: 8px;
            border-left: 4px solid #FF6B35;
        }
        .raid-category-title {
            color: #FF6B35;
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .raid-item {
            background: #2a2a2a;
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            border: 1px solid #444;
        }
        .raid-item-name {
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }
        .raid-item-desc {
            color: #ccc;
            font-size: 13px;
        }
        .generation-order {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .step {
            margin: 5px 0;
            padding: 5px 0;
        }
        .step.problem { color: #f44336; }
        .step.fixed { color: #4CAF50; }
    </style>
</head>
<body>
    <h1>üéØ Community Raids Dynamic i18n Test</h1>
    <p>Testing that dynamically generated raid items use proper i18n translations</p>
    
    <div class="test-section">
        <h2>Language Control</h2>
        <div style="margin-bottom: 15px;">
            Current: <span id="currentLang" class="current-lang">Loading...</span>
        </div>
        <button class="test-button" onclick="setEnglish()">English</button>
        <button class="test-button" onclick="setChinese()">‰∏≠Êñá</button>
        <button class="test-button" onclick="simulateExtensionLoad()">üîÑ Simulate Extension Load</button>
        <div id="initStatus" class="test-result">Initializing...</div>
    </div>
    
    <div class="test-section">
        <h2>üêõ Problem & Fix Explanation</h2>
        
        <div class="generation-order">
            <h3>‚ùå Before Fix - Wrong Initialization Order:</h3>
            <div class="step problem">1. Extension loads ‚Üí popup.js line 98: generateRaidSection() called</div>
            <div class="step problem">2. At this point: window.extensionI18n = undefined (not initialized yet)</div>
            <div class="step problem">3. Raid items generated with English fallback text</div>
            <div class="step problem">4. Later: popup.js line 699: i18n system initializes</div>
            <div class="step problem">5. Result: Raid items stuck in English ‚ùå</div>
        </div>
        
        <div class="generation-order">
            <h3>‚úÖ After Fix - Correct Initialization Order:</h3>
            <div class="step fixed">1. Extension loads ‚Üí popup.js line 98: generateRaidSection() called (still English)</div>
            <div class="step fixed">2. Later: popup.js line 699: i18n system initializes</div>
            <div class="step fixed">3. NEW: popup.js line 726: generateRaidSection() called AGAIN with i18n</div>
            <div class="step fixed">4. Result: Raid items properly translated ‚úÖ</div>
        </div>
        
        <p><strong>Fix Applied:</strong> Added <code>generateRaidSection();</code> after i18n initialization</p>
    </div>
    
    <div class="test-section">
        <h2>üéØ Simulated Community Raids Items</h2>
        <div id="mockRaidCategories">
            <!-- Will be dynamically generated to simulate the real extension -->
        </div>
    </div>
    
    <div class="test-section">
        <h2>üìä Test Results</h2>
        <div id="testResults" class="test-result">
            <p><strong>Instructions:</strong></p>
            <ol>
                <li>Click "Simulate Extension Load" to see the generation process</li>
                <li>Switch languages to verify translations work</li>
                <li>Check that raid items show in Chinese when Chinese is selected</li>
            </ol>
        </div>
    </div>

    <script src="extension-i18n-next.js"></script>
    <script src="nylago-data.js"></script>
    <script>
        let i18n = null;
        let simulationStep = 0;
        
        // Mock Chrome storage
        window.chrome = window.chrome || {
            storage: {
                sync: {
                    set: (data, cb) => {
                        Object.keys(data).forEach(k => localStorage.setItem('test_' + k, data[k]));
                        if (cb) cb();
                    },
                    get: (keys, cb) => {
                        const result = {};
                        const keysList = Array.isArray(keys) ? keys : [keys];
                        keysList.forEach(k => {
                            const val = localStorage.getItem('test_' + k);
                            if (val) result[k] = val;
                        });
                        cb(result);
                    }
                }
            }
        };
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (window.getExtensionI18n) {
                    i18n = window.getExtensionI18n();
                } else {
                    i18n = new ExtensionI18nNext();
                }
                
                await i18n.initialize();
                updateDisplay();
                document.getElementById('initStatus').innerHTML = '<span class="success">‚úÖ Ready! Click "Simulate Extension Load" to test the fix.</span>';
            } catch (e) {
                document.getElementById('initStatus').innerHTML = '<span class="error">‚ùå Error: ' + e.message + '</span>';
            }
        });
        
        function setEnglish() {
            if (i18n) {
                i18n.changeLanguage('en').then(() => {
                    updateDisplay();
                    // Regenerate raids with new language
                    generateMockRaidSection();
                });
            }
        }
        
        function setChinese() {
            if (i18n) {
                i18n.changeLanguage('zh').then(() => {
                    updateDisplay();
                    // Regenerate raids with new language
                    generateMockRaidSection();
                });
            }
        }
        
        function updateDisplay() {
            if (!i18n) return;
            
            const lang = i18n.getCurrentLanguage();
            document.getElementById('currentLang').textContent = lang === 'zh' ? '‰∏≠Êñá' : 'English';
        }
        
        function simulateExtensionLoad() {
            simulationStep = 0;
            const results = [];
            
            results.push('<strong>üîÑ Simulating Extension Load Process:</strong><br>');
            
            const steps = [
                { 
                    action: () => generateMockRaidSectionWithoutI18n(),
                    message: '1. ‚ùå First generation (line 98): No i18n available ‚Üí English fallback',
                    delay: 1000
                },
                {
                    action: () => {
                        // Simulate i18n initialization
                        results.push('2. ‚úÖ i18n system initializes (line 699)...<br>');
                        document.getElementById('testResults').innerHTML = results.join('');
                    },
                    message: '2. ‚úÖ i18n system initializes...',
                    delay: 1000
                },
                {
                    action: () => generateMockRaidSection(),
                    message: '3. ‚úÖ FIXED: Second generation (line 726): With i18n ‚Üí Proper translations!',
                    delay: 1000
                }
            ];
            
            let stepIndex = 0;
            function runStep() {
                if (stepIndex < steps.length) {
                    const step = steps[stepIndex];
                    step.action();
                    results.push(step.message + '<br>');
                    document.getElementById('testResults').innerHTML = results.join('');
                    stepIndex++;
                    setTimeout(runStep, step.delay);
                } else {
                    results.push('<br><strong>‚úÖ Result: Community Raids items now properly translated!</strong>');
                    document.getElementById('testResults').innerHTML = results.join('');
                }
            }
            
            runStep();
        }
        
        function generateMockRaidSectionWithoutI18n() {
            // Simulate the initial generation without i18n (what happens on line 98)
            generateMockRaidSection(false);
        }
        
        function generateMockRaidSection(useI18n = true) {
            const container = document.getElementById('mockRaidCategories');
            if (!container || !window.NYLA_RAID_DATA) return;
            
            container.innerHTML = '';
            
            window.NYLA_RAID_DATA.categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'demo-raid-item';
                
                // Category title
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'raid-category-title';
                
                if (useI18n && i18n && category.i18nKey) {
                    categoryTitle.textContent = i18n.t(category.i18nKey);
                } else {
                    categoryTitle.textContent = category.title;
                }
                
                categoryDiv.appendChild(categoryTitle);
                
                // Category items
                category.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'raid-item';
                    
                    const itemName = document.createElement('div');
                    itemName.className = 'raid-item-name';
                    
                    const itemDesc = document.createElement('div');
                    itemDesc.className = 'raid-item-desc';
                    
                    if (useI18n && i18n && item.i18nNameKey && item.i18nDescKey) {
                        itemName.textContent = i18n.t(item.i18nNameKey);
                        itemDesc.textContent = i18n.t(item.i18nDescKey);
                    } else {
                        itemName.textContent = item.name;
                        itemDesc.textContent = item.description;
                    }
                    
                    itemDiv.appendChild(itemName);
                    itemDiv.appendChild(itemDesc);
                    categoryDiv.appendChild(itemDiv);
                });
                
                container.appendChild(categoryDiv);
            });
            
            // Add status indicator
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'text-align: center; padding: 10px; margin-top: 10px; background: #444; border-radius: 4px;';
            statusDiv.innerHTML = useI18n ? 
                '<span class="success">‚úÖ Generated WITH i18n support</span>' : 
                '<span class="error">‚ùå Generated WITHOUT i18n support (fallback to English)</span>';
            container.appendChild(statusDiv);
        }
    </script>
</body>
</html>