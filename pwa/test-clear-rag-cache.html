<!DOCTYPE html>
<html>
<head>
    <title>Clear RAG Cache</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 20px; margin: 10px 5px; }
    </style>
</head>
<body>
    <h1>Clear RAG Cache</h1>
    <p>This page helps clear various caches that might be preventing the latest embeddings from loading.</p>
    
    <button onclick="clearServiceWorkerCache()">Clear Service Worker Cache</button>
    <button onclick="clearIndexedDB()">Clear IndexedDB</button>
    <button onclick="clearLocalStorage()">Clear LocalStorage</button>
    <button onclick="clearAllCaches()">Clear All Caches</button>
    <button onclick="forceRefreshPage()">Force Page Refresh</button>
    
    <div id="logs"></div>
    
    <script>
        const logs = document.getElementById('logs');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            console.log(message);
        }
        
        async function clearServiceWorkerCache() {
            try {
                log('ğŸ§¹ Clearing Service Worker caches...', 'info');
                
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    log(`ğŸ“¦ Found ${cacheNames.length} cache(s): ${cacheNames.join(', ')}`, 'info');
                    
                    for (const cacheName of cacheNames) {
                        const deleted = await caches.delete(cacheName);
                        log(`${deleted ? 'âœ…' : 'âŒ'} Cache '${cacheName}' ${deleted ? 'deleted' : 'not deleted'}`, deleted ? 'success' : 'error');
                    }
                } else {
                    log('â„¹ï¸ Caches API not available', 'warning');
                }
            } catch (error) {
                log(`âŒ Error clearing caches: ${error.message}`, 'error');
            }
        }
        
        async function clearIndexedDB() {
            try {
                log('ğŸ§¹ Clearing IndexedDB...', 'info');
                
                // NYLA embedding storage
                const dbName = 'nyla-embeddings-storage';
                try {
                    const deleteRequest = indexedDB.deleteDatabase(dbName);
                    deleteRequest.onsuccess = () => log(`âœ… IndexedDB '${dbName}' deleted`, 'success');
                    deleteRequest.onerror = () => log(`âŒ Error deleting IndexedDB '${dbName}'`, 'error');
                } catch (error) {
                    log(`âŒ Error accessing IndexedDB: ${error.message}`, 'error');
                }
                
                log('âœ… IndexedDB clear initiated', 'success');
            } catch (error) {
                log(`âŒ Error clearing IndexedDB: ${error.message}`, 'error');
            }
        }
        
        function clearLocalStorage() {
            try {
                log('ğŸ§¹ Clearing LocalStorage...', 'info');
                const itemCount = localStorage.length;
                localStorage.clear();
                log(`âœ… Cleared ${itemCount} LocalStorage items`, 'success');
            } catch (error) {
                log(`âŒ Error clearing LocalStorage: ${error.message}`, 'error');
            }
        }
        
        async function clearAllCaches() {
            log('ğŸ§¹ Clearing all caches...', 'info');
            await clearServiceWorkerCache();
            await clearIndexedDB();
            clearLocalStorage();
            log('âœ… All cache clearing operations completed', 'success');
        }
        
        function forceRefreshPage() {
            log('ğŸ”„ Force refreshing page...', 'info');
            // Hard refresh with cache bypass
            window.location.reload(true);
        }
        
        // Show current cache status on load
        window.addEventListener('load', async () => {
            log('ğŸ“Š Checking current cache status...', 'info');
            
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                log(`ğŸ“¦ Service Worker caches: ${cacheNames.length} found`, 'info');
            }
            
            log(`ğŸ’¾ LocalStorage items: ${localStorage.length}`, 'info');
            log(`ğŸ—‚ï¸ Ready to clear caches`, 'success');
        });
    </script>
</body>
</html>